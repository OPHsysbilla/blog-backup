---
title: Android项目设计
date: 2021-02-02 10:51:54
tags:
---


## IM丢消息怎么办？用的什么来保证顺序？群聊怎么实现的？
> [ACK机制：如何保证消息的可靠投递？](https://geekdaxue.co/read/fxbin@tech/qxlrn1)
1. 通过业务层的 ACK 确认和重传机制，能解决大部分推送过程中消息丢失的情况。
2. 通过客户端的去重机制（生成UUID），屏蔽掉重传过程中可能导致消息重复的问题，从而不影响用户体验。
3. 完整性检查机制：兜底定时轮询服务器`Pull`大于某个时间戳的最新消息，来及时发现消息丢失的情况并进行补推修复。消息完整性检查可以通过时间戳比对，或者全局自增序列等方式来实现。

## 消息序号生成器：如何保证你的消息不会乱序？
依靠服务端的全局序号生成器
1）生产者为每个消息包生成一个packageID，为包内的每条消息加个有序自增的seqID（注：这里的seqID和推送时的SeqID不是一个概念，这是的seqID只是当前这个包的序号，推送时不用看这个）；

2）消费者根据每条消息的packageID 和 seqID 进行整流和排序；

3）执行模块只有在一定超时时间内完整有序地收到所有消息才执行最终操作，否则根据业务需要触发重试或直接放弃操作。

消息接收端整流

1）发送方发送消息时，连同消息和序号一起发送给接收方；

2）接收方接收到消息后，先去查找上一条消息的序号，然后比对收到的序号和上一条消息的序号；

3）如果收到的消息序号大于上一条消息序号，直接追加；反之则去查找小于该序号的最大消息序号，并追加到其后。
[IM系统如何保证消息的一致性](https://www.cnblogs.com/sunshineliulu/p/11507756.html)